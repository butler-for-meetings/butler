image: docker:stable

stages:
  - lint
  - build

variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2

services:
  - docker:dind


js linter:
  image: node:latest
  stage: lint
  before_script:
    - npm install
  script:
    - npx ng lint


py linter:
  image: python:3.7
  stage: lint
  before_script:
    - pip install tox pylint flake8
  script:
    - tox


.build_docker: &build_docker
  stage: build
  script:
    - docker build -t $IMAGE_NAME:latest -f $DOCKERFILE_PATH .


build client:
  <<: *build_docker
  variables:
    IMAGE_NAME: $CI_REGISTRY/$CI_PROJECT_PATH/client-production
    DOCKERFILE_PATH: app/client/Dockerfile-prod


build server:
  <<: *build_docker
  variables:
    IMAGE_NAME: $CI_REGISTRY/$CI_PROJECT_PATH/client-production
    DOCKERFILE_PATH: app/server/Dockerfile
